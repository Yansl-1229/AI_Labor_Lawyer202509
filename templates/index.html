<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠ³åŠ¨æ³•å¾‹å¸ˆå’¨è¯¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 90vh;
            max-height: 95vh;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 10px 20px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            color: #6c757d;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.system {
            justify-content: center;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.lawyer .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }

        .message.system .message-content {
            background: #28a745;
            color: white;
            font-size: 14px;
            text-align: center;
        }

        .message.error .message-content {
            background: #dc3545;
            color: white;
            text-align: center;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .message.user .avatar {
            background: #007bff;
            color: white;
            order: 1;
        }

        .message.lawyer .avatar {
            background: #28a745;
            color: white;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #007bff;
        }

        .send-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            background: #0056b3;
        }

        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .service-selection {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: none;
        }

        .service-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .service-option {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .service-option:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .service-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .service-option h3 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .service-option ul {
            list-style: none;
            text-align: left;
        }

        .service-option li {
            padding: 5px 0;
            font-size: 14px;
            color: #666;
        }

        .service-option li:before {
            content: "â€¢ ";
            color: #007bff;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .action-btn.primary {
            background: #007bff;
            color: white;
        }

        .action-btn.primary:hover {
            background: #0056b3;
        }

        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #545b62;
        }

        .action-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .phase-indicator {
            background: #e3f2fd;
            padding: 10px 20px;
            text-align: center;
            font-weight: bold;
            color: #1976d2;
            border-bottom: 1px solid #bbdefb;
        }

        .analysis-result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        .formatted-report {
            background: #ffffff;
            border: 1px solid #d1ecf1;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .formatted-report h1, .formatted-report h2, .formatted-report h3 {
            color: #0c5460;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .formatted-report strong {
            color: #0c5460;
            font-weight: bold;
        }

        .formatted-report ul, .formatted-report ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .formatted-report li {
            margin-bottom: 5px;
        }

        .evidence-choice {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
        }

        .evidence-choice h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .upload-section {
            margin: 20px 0;
            text-align: left;
            max-height: 20vh;
            overflow-y: auto;
            min-height: 150px;
        }

        .evidence-types-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .evidence-type-section {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .evidence-type-header {
            margin-bottom: 15px;
            text-align: center;
        }

        .evidence-type-header h5 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 16px;
            font-weight: bold;
        }

        .evidence-type-desc {
            font-size: 12px;
            color: #666;
            display: block;
        }

        .upload-dropzone {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .evidence-dropzone {
            border: 2px dashed #ddd;
            background: #fafafa;
        }

        .evidence-dropzone:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .evidence-dropzone.dragover {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .upload-dropzone:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }

        .upload-dropzone.dragover {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .file-list {
            max-height: 120px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .file-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .file-name {
            font-size: 14px;
            color: #333;
            margin-right: 10px;
        }

        .file-size {
            font-size: 12px;
            color: #6c757d;
        }

        .file-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .file-remove:hover {
            background: #c82333;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }

        /* ä¸¾è¯åˆ†æè¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼ */
        .evidence-progress {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .step.active .step-number {
            background: #007bff;
            color: white;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-title {
            font-size: 12px;
            text-align: center;
            color: #6c757d;
            max-width: 80px;
        }

        .step.active .step-title {
            color: #007bff;
            font-weight: bold;
        }

        .step.completed .step-title {
            color: #28a745;
        }

        /* è¯æ®æ¸…å•æ”¶é›†ç•Œé¢æ ·å¼ */
        .evidence-inventory {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            min-height: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .evidence-inventory h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .evidence-inventory textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .evidence-inventory textarea:focus {
            border-color: #007bff;
            outline: none;
        }

        #evidence-list-display {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 500px;
            overflow-y: auto;
            min-height: 150px;
        }

        #parsed-evidence-result {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 600px;
            overflow-y: auto;
            min-height: 200px;
        }

        #parsed-evidence-result h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .evidence-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 12px;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
            margin-bottom: 5px;
        }

        .evidence-item:hover {
            background-color: #f8f9fa;
        }

        .evidence-item:last-child {
            border-bottom: none;
        }

        .evidence-info {
            flex: 1;
        }

        .evidence-name {
            font-weight: bold;
            color: #333;
        }

        .evidence-type {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        /* è¯æ®åˆ†æè¯„ä¼°ç•Œé¢æ ·å¼ */
        .evidence-analysis {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            max-height: 42vh;
            overflow-y: auto;
            min-height: 300px;
        }

        .evidence-analysis h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .evidence-analysis h4 {
            margin: 15px 0 10px 0;
            color: #495057;
        }

        #evidence-overview {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 150px;
            overflow-y: auto;
        }

        .analysis-controls {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .evidence-file-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .evidence-file-selector select {
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }

        .evidence-file-selector select:focus {
            border-color: #007bff;
            outline: none;
        }

        #analysis-progress {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        #analyzed-files-list {
            margin-top: 15px;
        }

        .analyzed-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .file-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
        }

        .file-status.valid {
            background: #28a745;
        }

        .file-status.invalid {
            background: #dc3545;
        }

        .file-status.unknown {
            background: #6c757d;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .upload-section::-webkit-scrollbar,
        .evidence-types-container::-webkit-scrollbar,
        .evidence-analysis::-webkit-scrollbar,
        #evidence-list-display::-webkit-scrollbar,
        #parsed-evidence-result::-webkit-scrollbar {
            width: 8px;
        }

        .upload-section::-webkit-scrollbar-track,
        .evidence-types-container::-webkit-scrollbar-track,
        .evidence-analysis::-webkit-scrollbar-track,
        #evidence-list-display::-webkit-scrollbar-track,
        #parsed-evidence-result::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .upload-section::-webkit-scrollbar-thumb,
        .evidence-types-container::-webkit-scrollbar-thumb,
        .evidence-analysis::-webkit-scrollbar-thumb,
        #evidence-list-display::-webkit-scrollbar-thumb,
        #parsed-evidence-result::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .upload-section::-webkit-scrollbar-thumb:hover,
        .evidence-types-container::-webkit-scrollbar-thumb:hover,
        .evidence-analysis::-webkit-scrollbar-thumb:hover,
        #evidence-list-display::-webkit-scrollbar-thumb:hover,
        #parsed-evidence-result::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                height: 90vh;
                border-radius: 10px;
            }

            .service-options {
                flex-direction: column;
            }

            .service-option {
                min-width: auto;
            }

            .message-content {
                max-width: 85%;
            }

            .progress-steps {
                flex-wrap: wrap;
                gap: 10px;
            }

            .step {
                flex: 1;
                min-width: 60px;
            }

            .step-title {
                font-size: 10px;
            }

            .evidence-file-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .evidence-file-selector select {
                min-width: auto;
                width: 100%;
            }
            
            #evidence-list-display,
            #parsed-evidence-result {
                max-height: 250px;
                padding: 10px;
                margin: 10px 0;
            }
            
            .evidence-item {
                padding: 8px;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .evidence-inventory textarea {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ AIåŠ³åŠ¨æ³•å¾‹å¸ˆå’¨è¯¢ç³»ç»Ÿ</h1>
            <p>ä¸“ä¸šçš„åŠ³åŠ¨äº‰è®®æ³•å¾‹å’¨è¯¢æœåŠ¡</p>
        </div>
        
        <div class="status-bar">
            <span id="status-text">å‡†å¤‡å°±ç»ª</span>
            <span id="session-info" style="float: right;"></span>
        </div>
        
        <div class="phase-indicator" id="phase-indicator" style="display: none;">
            å½“å‰é˜¶æ®µï¼š<span id="current-phase">å‡†å¤‡ä¸­</span>
        </div>
        
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="message system">
                    <div class="message-content">
                        æ¬¢è¿ä½¿ç”¨AIåŠ³åŠ¨æ³•å¾‹å¸ˆå’¨è¯¢ç³»ç»Ÿï¼ç‚¹å‡»ä¸‹æ–¹"å¼€å§‹å’¨è¯¢"æŒ‰é’®å¼€å§‹æ‚¨çš„æ³•å¾‹å’¨è¯¢ä¹‹æ—…ã€‚
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</span>
            </div>
        </div>
        
        <div class="input-area" id="input-area">
            <div class="input-group">
                <input type="text" class="message-input" id="message-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." disabled>
                <button class="send-btn" id="send-btn" disabled>å‘é€</button>
            </div>
            <div class="action-buttons" style="margin-top: 15px;">
                <button class="action-btn primary" id="start-btn">å¼€å§‹å’¨è¯¢</button>
                <button class="action-btn secondary" id="status-btn">æŸ¥çœ‹çŠ¶æ€</button>
            </div>
        </div>
        
        <!-- æœåŠ¡é€‰æ‹©ç•Œé¢ -->
        <div class="service-selection" id="service-selection">
            <h3 style="text-align: center; margin-bottom: 20px; color: #333;">è¯·é€‰æ‹©æœåŠ¡ç±»å‹</h3>
            <div class="service-options">
                <div class="service-option" data-service="free">
                    <h3>ğŸ†“ å…è´¹æœåŠ¡</h3>
                    <ul>
                        <li>åŸºç¡€æ¡ˆä¾‹åˆ†æ</li>
                        <li>äº‰è®®ç„¦ç‚¹æ¢³ç†</li>
                        <li>åŸºæœ¬æ³•å¾‹å»ºè®®</li>
                        <li>ç›´æ¥ç”ŸæˆæŠ¥å‘Š</li>
                    </ul>
                </div>
                <div class="service-option" data-service="premium">
                    <h3>ğŸ’ ä»˜è´¹æœåŠ¡</h3>
                    <ul>
                        <li>ä¸“ä¸šè¯æ®åˆè§„æ€§åˆ†æ</li>
                        <li>ç²¾ç¡®çš„ä»²è£èµ”å¿è®¡ç®—</li>
                        <li>å®Œæ•´çš„æ³•å¾‹ä¾æ®è¯´æ˜</li>
                        <li>å¯é€‰æ‹©ä¸¾è¯åˆ†æ</li>
                    </ul>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn primary" id="confirm-service-btn" disabled>ç¡®è®¤é€‰æ‹©</button>
            </div>
        </div>



        <!-- ä¸¾è¯åˆ†æè¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="evidence-progress" id="evidence-progress" style="display: none;">
            <div class="progress-steps">
                <div class="step" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">æ¡ˆä»¶ä¿¡æ¯æ”¶é›†</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">è¯æ®éœ€æ±‚ç”Ÿæˆ</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">è¯æ®æ”¶é›†æŒ‡å¯¼</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">è¯æ®æ¸…å•æ”¶é›†</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-title">è¯æ®åˆ†æè¯„ä¼°</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-number">6</div>
                    <div class="step-title">è¯æ®åˆ†æå¯¹è¯</div>
                </div>
            </div>
        </div>

        <!-- ä¸¾è¯åˆ†æé˜¶æ®µ4ï¼šè¯æ®æ¸…å•æ”¶é›†ç•Œé¢ -->
        <div class="evidence-inventory" id="evidence-inventory" style="display: none;">
            <h3>ğŸ“‹ è¯æ®æ¸…å•æ”¶é›†</h3>
            <p>è¯·æè¿°æ‚¨ç›®å‰æŒæœ‰çš„è¯æ®ï¼š</p>
            <textarea id="evidence-description" placeholder="ä¾‹å¦‚ï¼šæˆ‘ç›®å‰æ‰‹ä¸Šæœ‰åŠ³åŠ¨åˆåŒã€å·¥èµ„å•ã€é“¶è¡Œæµæ°´ã€èŠå¤©è®°å½•ç­‰..." rows="4"></textarea>
            <div class="action-buttons">
                <button class="action-btn primary" id="parse-evidence-btn">è§£æè¯æ®æ¸…å•</button>
            </div>
            
            <!-- è§£æç»“æœå±•ç¤º -->
            <div id="parsed-evidence-result" style="display: none;">
                <h4>è§£æç»“æœï¼š</h4>
                <div id="evidence-list-display"></div>
                <div class="action-buttons">
                    <button class="action-btn primary" id="confirm-evidence-btn">ç¡®è®¤è¯æ®æ¸…å•</button>
                    <button class="action-btn secondary" id="reparse-evidence-btn">é‡æ–°è¾“å…¥</button>
                </div>
            </div>
        </div>

        <!-- ä¸¾è¯åˆ†æé˜¶æ®µ5ï¼šè¯æ®åˆ†æè¯„ä¼°ç•Œé¢ -->
        <div class="evidence-analysis" id="evidence-analysis" style="display: none;">
            <h3>ğŸ”¬ è¯æ®åˆ†æè¯„ä¼°</h3>
            
            <!-- è¯æ®æ¦‚è§ˆ -->
            <div id="evidence-overview"></div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <h4>ä¸Šä¼ è¯æ®æ–‡ä»¶ï¼š</h4>
                <div class="upload-dropzone" id="upload-dropzone">
                    <div class="upload-icon">ğŸ“</div>
                    <div>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                    <div class="upload-hint">æ”¯æŒ PDFã€JPGã€PNGã€DOCã€DOCX ç­‰æ ¼å¼</div>
                    <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt" style="display: none;">
                </div>
                
                <!-- å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ -->
                <div id="uploaded-files" class="file-list"></div>
            </div>
            
            <!-- åˆ†ææ“ä½œåŒºåŸŸ -->
            <div class="analysis-controls">
                <h4>è¯æ®åˆ†ææ“ä½œï¼š</h4>
                <div class="evidence-file-selector">
                    <select id="file-selector">
                        <option value="">é€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶</option>
                    </select>
                    <select id="evidence-type-selector">
                        <option value="">é€‰æ‹©è¯æ®ç±»å‹</option>
                        <option value="contract">åŠ³åŠ¨åˆåŒ</option>
                        <option value="payslip">å·¥èµ„å•</option>
                        <option value="attendance">è€ƒå‹¤è®°å½•</option>
                        <option value="injury">å·¥ä¼¤é‰´å®š</option>
                        <option value="recording">å½•éŸ³</option>
                        <option value="chat">èŠå¤©è®°å½•</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                    <button class="action-btn primary" id="analyze-file-btn">åˆ†ææ–‡ä»¶</button>
                </div>
            </div>
            
            <!-- åˆ†æè¿›åº¦ -->
            <div id="analysis-progress" style="display: none;">
                <h4>åˆ†æè¿›åº¦ï¼š</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">0% å®Œæˆ</div>
                <div id="analyzed-files-list"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn secondary" id="check-progress-btn">æŸ¥çœ‹è¿›åº¦</button>
                <button class="action-btn primary" id="complete-analysis-btn" disabled>å®Œæˆåˆ†æ</button>
            </div>
        </div>
        

        

    </div>

    <script>
        class AILawyerChat {
            constructor() {
                this.sessionId = null;
                this.currentPhase = 'ready';
                this.selectedService = null;
                this.evidenceMode = false;
                this.currentEvidenceStage = 0;
                this.parsedEvidenceList = [];
                this.uploadedFiles = [];
                this.canProceedMessageShown = false; // é˜²æ­¢é‡å¤æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.elements = {
                    messages: document.getElementById('messages'),
                    messageInput: document.getElementById('message-input'),
                    sendBtn: document.getElementById('send-btn'),
                    startBtn: document.getElementById('start-btn'),
                    statusBtn: document.getElementById('status-btn'),
                    statusText: document.getElementById('status-text'),
                    sessionInfo: document.getElementById('session-info'),
                    phaseIndicator: document.getElementById('phase-indicator'),
                    currentPhase: document.getElementById('current-phase'),
                    loading: document.getElementById('loading'),
                    inputArea: document.getElementById('input-area'),
                    serviceSelection: document.getElementById('service-selection'),
                    confirmServiceBtn: document.getElementById('confirm-service-btn'),

                    // ä¸¾è¯åˆ†æç›¸å…³å…ƒç´ 
                    evidenceProgress: document.getElementById('evidence-progress'),
                    evidenceInventory: document.getElementById('evidence-inventory'),
                    evidenceAnalysis: document.getElementById('evidence-analysis'),
                    evidenceDescription: document.getElementById('evidence-description'),
                    parseEvidenceBtn: document.getElementById('parse-evidence-btn'),
                    parsedEvidenceResult: document.getElementById('parsed-evidence-result'),
                    evidenceListDisplay: document.getElementById('evidence-list-display'),
                    confirmEvidenceBtn: document.getElementById('confirm-evidence-btn'),
                    reparseEvidenceBtn: document.getElementById('reparse-evidence-btn'),
                    uploadDropzone: document.getElementById('upload-dropzone'),
                    fileInput: document.getElementById('file-input'),
                    uploadedFiles: document.getElementById('uploaded-files'),
                    fileSelector: document.getElementById('file-selector'),
                    evidenceTypeSelector: document.getElementById('evidence-type-selector'),
                    analyzeFileBtn: document.getElementById('analyze-file-btn'),
                    analysisProgress: document.getElementById('analysis-progress'),
                    progressFill: document.getElementById('progress-fill'),
                    progressText: document.getElementById('progress-text'),
                    analyzedFilesList: document.getElementById('analyzed-files-list'),
                    checkProgressBtn: document.getElementById('check-progress-btn'),
                    completeAnalysisBtn: document.getElementById('complete-analysis-btn'),
                    evidenceOverview: document.getElementById('evidence-overview')
                };
            }

            bindEvents() {
                // å‘é€æ¶ˆæ¯
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // å¼€å§‹å’¨è¯¢
                this.elements.startBtn.addEventListener('click', () => this.startSession());

                // æŸ¥çœ‹çŠ¶æ€
                this.elements.statusBtn.addEventListener('click', () => this.getStatus());

                // æœåŠ¡é€‰æ‹©
                document.querySelectorAll('#service-selection .service-option').forEach(option => {
                    option.addEventListener('click', () => this.selectService(option));
                });
                this.elements.confirmServiceBtn.addEventListener('click', () => this.confirmService());
                


                // ä¸¾è¯åˆ†æç›¸å…³äº‹ä»¶
                if (this.elements.parseEvidenceBtn) {
                    this.elements.parseEvidenceBtn.addEventListener('click', () => this.parseEvidence());
                }
                if (this.elements.confirmEvidenceBtn) {
                    this.elements.confirmEvidenceBtn.addEventListener('click', () => this.confirmEvidence());
                }
                if (this.elements.reparseEvidenceBtn) {
                    this.elements.reparseEvidenceBtn.addEventListener('click', () => this.reparseEvidence());
                }
                if (this.elements.uploadDropzone) {
                    this.elements.uploadDropzone.addEventListener('click', () => this.elements.fileInput.click());
                    this.elements.uploadDropzone.addEventListener('dragover', (e) => this.handleDragOver(e));
                    this.elements.uploadDropzone.addEventListener('drop', (e) => this.handleFileDrop(e));
                }
                if (this.elements.fileInput) {
                    this.elements.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }
                if (this.elements.analyzeFileBtn) {
                    this.elements.analyzeFileBtn.addEventListener('click', () => this.analyzeFile());
                }
                if (this.elements.checkProgressBtn) {
                    this.elements.checkProgressBtn.addEventListener('click', () => this.checkAnalysisProgress());
                }
                if (this.elements.completeAnalysisBtn) {
                    this.elements.completeAnalysisBtn.addEventListener('click', () => this.completeAnalysis());
                }
            }

            async startSession() {
                this.showLoading(true);
                try {
                    const response = await fetch('/api/start_session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.sessionId = result.session_id;
                        this.currentPhase = result.phase;
                        this.updateUI(result);
                        this.addMessage('system', result.message);
                        this.enableInput();
                    } else {
                        this.addMessage('error', result.error || 'å¯åŠ¨ä¼šè¯å¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async sendMessage() {
                const message = this.elements.messageInput.value.trim();
                if (!message || !this.sessionId) return;

                this.addMessage('user', message);
                this.elements.messageInput.value = '';
                this.elements.sendBtn.disabled = true;

                try {
                    if (this.evidenceMode && (this.currentEvidenceStage === 3 || this.currentEvidenceStage === 6)) {
                        // ä¸¾è¯åˆ†ææ¨¡å¼ä¸‹çš„æ¶ˆæ¯å¤„ç†ï¼ˆä¿æŒåŠ è½½æç¤ºï¼‰
                        this.showLoading(true);
                        await this.sendEvidenceMessage(message);
                    } else {
                        // æµå¼èŠå¤©æ¥å£ï¼šä¸æ˜¾ç¤ºåŠ è½½æç¤ºï¼Œç›´æ¥å¼€å§‹æµå¼è¾“å‡º
                        await this.sendStreamMessage(message);
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                    this.elements.sendBtn.disabled = false;
                }
            }

            addStreamingMessage(type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                let avatarText = '';
                switch (type) {
                    case 'user':
                        avatarText = 'æ‚¨';
                        break;
                    case 'lawyer':
                        avatarText = 'å¾‹å¸ˆ';
                        break;
                    case 'system':
                    case 'error':
                        break;
                }

                let contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.setAttribute('data-raw', '');

                if (avatarText) {
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'avatar';
                    avatarDiv.textContent = avatarText;
                    messageDiv.appendChild(avatarDiv);
                    messageDiv.appendChild(contentDiv);
                } else {
                    messageDiv.appendChild(contentDiv);
                }

                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
                return contentDiv;
            }

            async sendStreamMessage(message) {
                const contentDiv = this.addStreamingMessage('lawyer');
                const decoder = new TextDecoder('utf-8');

                try {
                    const response = await fetch('/api/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            message: message
                        })
                    });

                    if (!response.ok || !response.body) {
                        this.addMessage('error', 'å¤„ç†æ¶ˆæ¯å¤±è´¥');
                        return;
                    }

                    const reader = response.body.getReader();
                    let buffer = '';

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });

                        const events = buffer.split('\n\n');
                        buffer = events.pop() || '';

                        for (const evt of events) {
                            const lines = evt.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const jsonStr = line.slice(6).trim();
                                    try {
                                        const data = JSON.parse(jsonStr);
                                        const text = data.content || '';
                                        if (text) {
                                            const prev = contentDiv.getAttribute('data-raw') || '';
                                            const next = prev + text;
                                            contentDiv.setAttribute('data-raw', next);
                                            contentDiv.innerHTML = this.escapeHtml(next).replace(/\n/g, '<br>');
                                            this.scrollToBottom();
                                        }
                                    } catch (e) {
                                        // å¿½ç•¥JSONè§£æé”™è¯¯
                                    }
                                }
                            }
                        }
                    }

                    // æµç»“æŸåï¼Œæ£€æŸ¥ä¼šè¯çŠ¶æ€ä»¥å†³å®šæ˜¯å¦è¿›å…¥æ¡ˆä¾‹åˆ†æ
                    try {
                        const statusResp = await fetch(`/api/status?session_id=${this.sessionId}`);
                        const statusResult = await statusResp.json();
                        if (statusResult.success && statusResult.session_status === 'completed') {
                            this.currentPhase = 'case_analysis';
                            this.updatePhase('æ¡ˆä¾‹åˆ†æé˜¶æ®µ');
                            this.addMessage('system', 'âœ… ä¿¡æ¯æ”¶é›†é˜¶æ®µå®Œæˆï¼Œå¼€å§‹æ¡ˆä¾‹åˆ†æ');
                            setTimeout(() => this.performCaseAnalysis(), 1000);
                        }
                    } catch (e) {
                        // çŠ¶æ€æ£€æŸ¥å¤±è´¥å¿½ç•¥
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            }

            selectService(option) {
                document.querySelectorAll('#service-selection .service-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                this.selectedService = option.dataset.service;
                this.elements.confirmServiceBtn.disabled = false;
            }

            async confirmService() {
                if (!this.selectedService) return;

                this.showLoading(true);
                try {
                    if (this.selectedService === 'premium') {
                        // ä»˜è´¹æœåŠ¡ï¼šå¯ç”¨ä¸¾è¯åˆ†ææ¨¡å¼
                        await this.enableEvidenceMode();
                    } else if (this.selectedService === 'free') {
                        // å…è´¹æœåŠ¡ï¼šè°ƒç”¨APIé€‰æ‹©æœåŠ¡å¹¶ç›´æ¥ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
                        const response = await fetch('/api/select_service', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                service_type: this.selectedService
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            this.addMessage('system', result.message);
                            this.hideServiceSelection();
                            this.currentPhase = result.next_phase;
                            this.updatePhase(result.next_phase_name);
                            
                            // å…è´¹ç”¨æˆ·ç›´æ¥ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
                            setTimeout(() => this.generateFinalReport(), 1000);
                        } else {
                            this.addMessage('error', result.error || 'é€‰æ‹©æœåŠ¡å¤±è´¥');
                        }
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async performCaseAnalysis() {
                this.addMessage('system', 'ğŸ” æ­£åœ¨åˆ†ææ‚¨çš„æ¡ˆä¾‹ï¼Œè¯·ç¨å€™...');
                this.showLoading(true);
                
                try {
                    const response = await fetch('/api/case_analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('system', result.message);
                        this.addAnalysisResult('æ¡ˆä¾‹åˆ†ææŠ¥å‘Š', result.analysis_result);
                        
                        this.currentPhase = result.next_phase;
                        this.updatePhase(result.next_phase_name);
                        
                        // æ¡ˆä¾‹åˆ†æå®Œæˆåæ˜¾ç¤ºæœåŠ¡é€‰æ‹©ç•Œé¢
                        if (result.show_service_selection) {
                            setTimeout(() => this.showServiceSelection(), 1000);
                        }
                    } else {
                        this.addMessage('error', result.error || 'æ¡ˆä¾‹åˆ†æå¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }



            async generateFinalReport() {
                this.addMessage('system', 'ğŸ“Š æ­£åœ¨ç”Ÿæˆç»¼åˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...');
                this.showLoading(true);
                
                try {
                    const response = await fetch('/api/final_report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('system', result.message);
                        
                        // æ˜¾ç¤ºå®Œæ•´çš„æœ€ç»ˆæŠ¥å‘Š
                        if (result.formatted_final_report) {
                            this.addFormattedReport('ç»¼åˆå’¨è¯¢æŠ¥å‘Š', result.formatted_final_report);
                        }
                        
                        // æ˜¾ç¤ºæ‘˜è¦ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
                        this.addFinalSummary(result.summary);
                        
                        this.currentPhase = 'finished';
                        this.updatePhase('å’¨è¯¢å®Œæˆ');
                        this.disableInput();
                    } else {
                        this.addMessage('error', result.error || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            // ä¸¾è¯åˆ†æç›¸å…³æ–¹æ³•
            async enableEvidenceMode() {
                try {
                    const response = await fetch('/api/evidence/enable', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.evidenceMode = true;
                        this.currentEvidenceStage = 1;
                        this.addMessage('system', result.message);
                        this.hideServiceSelection();
                        this.showEvidenceProgress();
                        this.updateEvidenceStep(1);
                        
                        // è‡ªåŠ¨å¼€å§‹é˜¶æ®µ1ï¼šæ¡ˆä»¶ä¿¡æ¯æ”¶é›†
                        setTimeout(() => this.evidenceStage1(), 1000);
                    } else {
                        this.addMessage('error', result.error || 'å¯ç”¨ä¸¾è¯åˆ†ææ¨¡å¼å¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            }

            async evidenceStage1() {
                this.addMessage('system', 'ğŸ” é˜¶æ®µ1ï¼šæ­£åœ¨æ”¶é›†æ¡ˆä»¶ä¿¡æ¯...');
                this.showLoading(true);
                
                try {
                    const response = await fetch('/api/evidence/stage1', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('system', result.message);
                        this.addCaseInfo('æ¡ˆä»¶ä¿¡æ¯', result.case_info);
                        this.updateEvidenceStep(2);
                        
                        // è‡ªåŠ¨è¿›å…¥é˜¶æ®µ2
                        setTimeout(() => this.evidenceStage2(), 1000);
                    } else {
                        this.addMessage('error', result.error || 'æ¡ˆä»¶ä¿¡æ¯æ”¶é›†å¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async evidenceStage2() {
                this.addMessage('system', 'ğŸ“‹ é˜¶æ®µ2ï¼šæ­£åœ¨ç”Ÿæˆè¯æ®æ¸…å•...');
                this.showLoading(true);
                
                try {
                    const response = await fetch('/api/evidence/stage2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('system', result.message);
                        this.addEvidenceList('è¯æ®æ¸…å•', result.evidence_list);
                        this.updateEvidenceStep(3);
                        
                        // è¿›å…¥é˜¶æ®µ3ï¼šè¯æ®æ”¶é›†æŒ‡å¯¼
                        this.evidenceStage3();
                    } else {
                        this.addMessage('error', result.error || 'è¯æ®æ¸…å•ç”Ÿæˆå¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            evidenceStage3() {
                this.addMessage('system', 'ğŸ’¬ é˜¶æ®µ3ï¼šè¯æ®æ”¶é›†æŒ‡å¯¼é˜¶æ®µ\n\næ‚¨å¯ä»¥æ ¹æ®ä¸Šè¿°è¯æ®æ¸…å•è¯¢é—®æ‚¨ç–‘æƒ‘çš„åœ°æ–¹ï¼Œæˆ‘å°†ä¸ºæ‚¨è¿›è¡Œè§£ç­”ã€‚\nå¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œè¯·å›ç­”"æ²¡æœ‰"ï¼Œæˆ‘ä»¬å°†è·³è½¬åˆ°è¯æ®æ¸…å•æ”¶é›†é˜¶æ®µã€‚');
                this.enableInput();
                this.currentEvidenceStage = 3;
            }

            async sendEvidenceMessage(message) {
                if (this.currentEvidenceStage === 3) {
                    // é˜¶æ®µ3ï¼šè¯æ®æ”¶é›†æŒ‡å¯¼å¯¹è¯
                    const response = await fetch('/api/evidence/stage3', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            message: message
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('lawyer', result.response);
                        
                        if (result.stage_completed) {
                            this.updateEvidenceStep(4);
                            this.evidenceStage4();
                        }
                    } else {
                        this.addMessage('error', result.error || 'å¤„ç†æ¶ˆæ¯å¤±è´¥');
                    }
                } else if (this.currentEvidenceStage === 6) {
                    // é˜¶æ®µ6ï¼šè¯æ®åˆ†æå¯¹è¯
                    const response = await fetch('/api/evidence/stage6', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            message: message
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('lawyer', result.response);
                        
                        if (result.all_stages_completed) {
                            this.addMessage('system', result.final_message);
                            this.updateEvidenceStep(6, true);
                            this.disableInput();
                            
                            // æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬åˆ°ç»¼åˆå’¨è¯¢æŠ¥å‘Š
                            if (result.show_comprehensive_report) {
                                setTimeout(() => {
                                    this.addMessage('system', 'ğŸ“Š æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆç»¼åˆå’¨è¯¢æŠ¥å‘Š...');
                                    this.generateFinalReport();
                                }, 2000);
                            }
                        } else {
                            // åœ¨æ¯æ¬¡å›å¤åæé†’ç”¨æˆ·å¦‚ä½•ç»“æŸæµç¨‹
                            setTimeout(() => {
                                this.addMessage('system', 'ğŸ’¡ æç¤ºï¼šå¦‚æœæ‚¨æ²¡æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·è¾“å…¥"æ²¡æœ‰"æ¥ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚');
                            }, 1000);
                        }
                    } else {
                        this.addMessage('error', result.error || 'å¤„ç†æ¶ˆæ¯å¤±è´¥');
                    }
                }
            }

            evidenceStage4() {
                this.disableInput();
                this.showEvidenceInventory();
                this.currentEvidenceStage = 4;
            }

            async parseEvidence() {
                const description = this.elements.evidenceDescription.value.trim();
                if (!description) {
                    alert('è¯·è¾“å…¥è¯æ®æè¿°');
                    return;
                }

                this.showLoading(true);
                try {
                    const response = await fetch('/api/evidence/stage4/collect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            evidence_description: description
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.parsedEvidenceList = result.parsed_evidence;
                        this.displayParsedEvidence(result.parsed_evidence);
                        this.elements.parsedEvidenceResult.style.display = 'block';
                    } else {
                        this.addMessage('error', result.error || 'è§£æè¯æ®å¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async confirmEvidence() {
                this.showLoading(true);
                try {
                    const response = await fetch('/api/evidence/stage4/confirm', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            confirmed: true,
                            evidence_list: this.parsedEvidenceList
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('system', result.message);
                        this.hideEvidenceInventory();
                        this.updateEvidenceStep(5);
                        this.evidenceStage5();
                    } else {
                        this.addMessage('error', result.error || 'ç¡®è®¤è¯æ®å¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            reparseEvidence() {
                this.elements.parsedEvidenceResult.style.display = 'none';
                this.elements.evidenceDescription.value = '';
                this.elements.evidenceDescription.focus();
            }

            async evidenceStage5() {
                this.showEvidenceAnalysis();
                this.currentEvidenceStage = 5;
                this.canProceedMessageShown = false; // é‡ç½®æç¤ºæ¶ˆæ¯æ ‡å¿—
                
                try {
                    const response = await fetch('/api/evidence/stage5/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.displayEvidenceOverview(result.evidence_overview);
                        this.loadUploadedFiles();
                    } else {
                        this.addMessage('error', result.error || 'å¼€å§‹è¯æ®åˆ†æå¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            }

            async analyzeFile() {
                const fileName = this.elements.fileSelector.value;
                const evidenceType = this.elements.evidenceTypeSelector.value;
                
                if (!fileName || !evidenceType) {
                    alert('è¯·é€‰æ‹©æ–‡ä»¶å’Œè¯æ®ç±»å‹');
                    return;
                }

                this.showLoading(true);
                try {
                    const response = await fetch('/api/evidence/stage5/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            file_name: fileName,
                            evidence_type: evidenceType
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('system', result.message);
                        this.addAnalysisResult('åˆ†æç»“æœ', JSON.stringify(result.analysis_result, null, 2));
                        
                        // æ›´æ–°è¿›åº¦å¹¶æ£€æŸ¥æŒ‰é’®çŠ¶æ€
                        await this.checkAnalysisProgress();
                        
                        // æ·»åŠ æç¤ºä¿¡æ¯
                        if (result.analysis_result) {
                            this.addMessage('system', 'âœ… æ–‡ä»¶åˆ†æå®Œæˆï¼æ‚¨å¯ä»¥ç»§ç»­åˆ†æå…¶ä»–æ–‡ä»¶ï¼Œæˆ–ç‚¹å‡»"å®Œæˆåˆ†æ"è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚');
                        }
                    } else {
                        this.addMessage('error', result.error || 'æ–‡ä»¶åˆ†æå¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async checkAnalysisProgress() {
                try {
                    const response = await fetch(`/api/evidence/stage5/progress?session_id=${this.sessionId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateAnalysisProgress(result);
                        
                        // ä½¿ç”¨åç«¯è¿”å›çš„can_proceedçŠ¶æ€æ¥æ§åˆ¶æŒ‰é’®
                        if (result.can_proceed) {
                            this.elements.completeAnalysisBtn.disabled = false;
                            this.elements.completeAnalysisBtn.textContent = 'âœ… å®Œæˆåˆ†æï¼ˆå¯è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼‰';
                            this.elements.completeAnalysisBtn.style.backgroundColor = '#28a745';
                            this.elements.completeAnalysisBtn.style.color = 'white';
                            console.log('åç«¯è¿”å›can_proceed=trueï¼Œå¯ç”¨å®Œæˆåˆ†ææŒ‰é’®');
                            
                            // æ·»åŠ æ˜æ˜¾çš„æç¤ºæ¶ˆæ¯ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
                            if (result.analyzed_count > 0 && !this.canProceedMessageShown) {
                                this.addMessage('system', `ğŸ¯ å·²åˆ†æ ${result.analyzed_count} ä¸ªæ–‡ä»¶ï¼Œç°åœ¨å¯ä»¥ç‚¹å‡»"å®Œæˆåˆ†æ"æŒ‰é’®è¿›å…¥è¯æ®åˆ†æå¯¹è¯é˜¶æ®µï¼`);
                                this.canProceedMessageShown = true;
                            }
                        } else {
                            this.elements.completeAnalysisBtn.disabled = true;
                            this.elements.completeAnalysisBtn.textContent = 'å®Œæˆåˆ†æï¼ˆè¯·å…ˆåˆ†æè‡³å°‘ä¸€ä¸ªæ–‡ä»¶ï¼‰';
                            this.elements.completeAnalysisBtn.style.backgroundColor = '#6c757d';
                            this.elements.completeAnalysisBtn.style.color = '#fff';
                            console.log('åç«¯è¿”å›can_proceed=falseï¼Œç¦ç”¨å®Œæˆåˆ†ææŒ‰é’®');
                        }
                    } else {
                        this.addMessage('error', result.error || 'è·å–è¿›åº¦å¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            }

            async completeAnalysis() {
                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if (this.elements.completeAnalysisBtn.disabled) {
                    return;
                }
                
                this.elements.completeAnalysisBtn.disabled = true;
                this.showLoading(true);
                
                try {
                    console.log('å¼€å§‹å®Œæˆè¯æ®åˆ†æï¼Œå½“å‰é˜¶æ®µ:', this.currentEvidenceStage);
                    
                    const response = await fetch('/api/evidence/stage5/complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    console.log('å®Œæˆåˆ†æAPIå“åº”:', result);
                    
                    if (result.success) {
                        this.addMessage('system', result.message);
                        
                        // æ·»åŠ æ›´æ˜æ˜¾çš„é˜¶æ®µè½¬æ¢æç¤º
                        this.addMessage('system', 'ğŸ¯ æ­£åœ¨è¿›å…¥é˜¶æ®µ6ï¼šè¯æ®åˆ†æå¯¹è¯é˜¶æ®µ...');
                        
                        // éšè—è¯æ®åˆ†æç•Œé¢
                        this.hideEvidenceAnalysis();
                        
                        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
                        this.updateEvidenceStep(6);
                        
                        // å»¶è¿Ÿä¸€ä¸‹å†è¿›å…¥é˜¶æ®µ6ï¼Œè®©ç”¨æˆ·çœ‹åˆ°è½¬æ¢è¿‡ç¨‹
                        setTimeout(() => {
                            this.evidenceStage6();
                            console.log('å·²è¿›å…¥é˜¶æ®µ6ï¼Œå½“å‰é˜¶æ®µ:', this.currentEvidenceStage);
                        }, 1000);
                        
                    } else {
                        this.addMessage('error', result.error || 'å®Œæˆåˆ†æå¤±è´¥');
                        this.elements.completeAnalysisBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('å®Œæˆåˆ†ææ—¶å‘ç”Ÿé”™è¯¯:', error);
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                    this.elements.completeAnalysisBtn.disabled = false;
                } finally {
                    this.showLoading(false);
                }
            }

            evidenceStage6() {
                console.log('è¿›å…¥evidenceStage6æ–¹æ³•');
                
                // ç¡®ä¿éšè—è¯æ®åˆ†æç•Œé¢
                this.hideEvidenceAnalysis();
                
                // æ˜¾ç¤ºè¾“å…¥åŒºåŸŸ
                this.showInput();
                
                // æ·»åŠ é˜¶æ®µ6çš„æ¬¢è¿æ¶ˆæ¯
                this.addMessage('system', 'ğŸ‰ æ­å–œæ‚¨å®Œæˆè¯æ®åˆ†æè¯„ä¼°ï¼');
                this.addMessage('system', 'ğŸ’¬ é˜¶æ®µ6ï¼šè¯æ®åˆ†æå¯¹è¯é˜¶æ®µ\n\nç°åœ¨æ‚¨å¯ä»¥ï¼š\nâ€¢ è¯¢é—®å…³äºå·²åˆ†æè¯æ®çš„ä»»ä½•é—®é¢˜\nâ€¢ å’¨è¯¢æ³•å¾‹å»ºè®®å’Œç»´æƒç­–ç•¥\nâ€¢ äº†è§£è¯æ®çš„æ³•å¾‹æ•ˆåŠ›\n\nå¦‚æœæ²¡æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·å›ç­”"æ²¡æœ‰"æ¥ç”Ÿæˆæœ€ç»ˆçš„æ³•å¾‹å’¨è¯¢æŠ¥å‘Šã€‚');
                
                // æ·»åŠ æ›´æ˜æ˜¾çš„ç»“æŸæç¤º
                setTimeout(() => {
                    this.addMessage('system', 'ğŸ”” é‡è¦æç¤ºï¼šå½“æ‚¨å®Œæˆæ‰€æœ‰å’¨è¯¢åï¼Œè¯·è¾“å…¥"æ²¡æœ‰"æ¥ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šå¹¶ç»“æŸæµç¨‹ã€‚');
                }, 2000);
                
                // å¯ç”¨è¾“å…¥åŠŸèƒ½
                this.enableInput();
                
                // æ›´æ–°å½“å‰é˜¶æ®µ
                this.currentEvidenceStage = 6;
                
                // ç¡®ä¿è¿›åº¦æŒ‡ç¤ºå™¨æ˜¾ç¤ºæ­£ç¡®
                this.updateEvidenceStep(6);
                
                console.log('é˜¶æ®µ6åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰é˜¶æ®µ:', this.currentEvidenceStage);
            }

            async getStatus() {
                if (!this.sessionId) {
                    this.addMessage('system', 'å°šæœªå¼€å§‹ä¼šè¯');
                    return;
                }

                try {
                    const response = await fetch(`/api/status?session_id=${this.sessionId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        const statusInfo = `
ğŸ“Š å½“å‰çŠ¶æ€ï¼š
â€¢ ä¼šè¯ID: ${result.session_id}
â€¢ ç”¨æˆ·ç±»å‹: ${result.user_type}
â€¢ ä¼šè¯çŠ¶æ€: ${result.session_status}
â€¢ å·²å®Œæˆæ¡ˆä¾‹åˆ†æ: ${result.has_case_analysis ? 'æ˜¯' : 'å¦'}
`;
                        this.addMessage('system', statusInfo);
                    } else {
                        this.addMessage('error', result.error || 'è·å–çŠ¶æ€å¤±è´¥');
                    }
                } catch (error) {
                    this.addMessage('error', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            }

            addMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                let avatarText = '';
                switch (type) {
                    case 'user':
                        avatarText = 'æ‚¨';
                        break;
                    case 'lawyer':
                        avatarText = 'å¾‹å¸ˆ';
                        break;
                    case 'system':
                    case 'error':
                        break;
                }

                if (avatarText) {
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'avatar';
                    avatarDiv.textContent = avatarText;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    // ä½¿ç”¨textContentä¿æŒæ ‡ç‚¹ç¬¦å·å®Œæ•´æ€§ï¼Œç„¶åå¤„ç†æ¢è¡Œ
                    contentDiv.innerHTML = this.escapeHtml(content).replace(/\n/g, '<br>');
                    
                    messageDiv.appendChild(avatarDiv);
                    messageDiv.appendChild(contentDiv);
                } else {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    // ä½¿ç”¨textContentä¿æŒæ ‡ç‚¹ç¬¦å·å®Œæ•´æ€§ï¼Œç„¶åå¤„ç†æ¢è¡Œ
                    contentDiv.innerHTML = this.escapeHtml(content).replace(/\n/g, '<br>');
                    
                    messageDiv.appendChild(contentDiv);
                }

                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // åˆ é™¤ addGuidanceResult æ–¹æ³•

            addEvidenceList(title, evidenceList) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                let listHtml = `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #495057; margin-bottom: 10px; font-size: 16px;">${title}</h4>`;
                
                if (evidenceList && evidenceList.length > 0) {
                    evidenceList.forEach((evidence, index) => {
                        const importanceColor = evidence.importance === 'å…³é”®è¯æ®' ? '#dc3545' : 
                                              evidence.importance === 'é‡è¦è¯æ®' ? '#ffc107' : '#28a745';
                        const importanceIcon = evidence.importance === 'å…³é”®è¯æ®' ? 'ğŸ”´' : 
                                             evidence.importance === 'é‡è¦è¯æ®' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                        
                        listHtml += `
                            <div style="border-left: 3px solid ${importanceColor}; padding-left: 12px; margin: 10px 0;">
                                <div style="font-weight: bold; color: #495057; margin-bottom: 5px;">
                                    ${importanceIcon} ${evidence.type || evidence.evidence_type || 'æœªçŸ¥ç±»å‹'} (${evidence.importance || 'æœªçŸ¥é‡è¦æ€§'})
                                </div>
                                <div style="color: #6c757d; font-size: 14px; margin-bottom: 5px;">
                                    <strong>ä½œç”¨ï¼š</strong>${evidence.description || 'æ— æè¿°'}
                                </div>
                                <div style="color: #6c757d; font-size: 14px; margin-bottom: 5px;">
                                    <strong>æ³•å¾‹è¦ä»¶ï¼š</strong>${evidence.legal_basis || evidence.legal_requirements || 'æ— ä¾æ®'}
                                </div>
                                <div style="color: #6c757d; font-size: 14px;">
                                    <strong>å–è¯æ–¹æ³•ï¼š</strong>${evidence.collection_method || 'æ— æ–¹æ³•'}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    listHtml += '<p style="color: #6c757d;">æš‚æ— è¯æ®æ¸…å•</p>';
                }
                
                listHtml += '</div>';
                contentDiv.innerHTML = listHtml;
                
                messageDiv.appendChild(contentDiv);
                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            addAnalysisResult(title, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <strong>${title}ï¼š</strong>
                        <div class="analysis-result">${content}</div>
                    </div>
                `;
                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            addFormattedReport(title, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <strong>${title}ï¼š</strong>
                        <div class="formatted-report">${this.formatReportContent(content)}</div>
                    </div>
                `;
                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            formatReportContent(content) {
                // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œ
                return content.replace(/\n/g, '<br>');
            }

            addFinalSummary(summary) {
                let summaryText = `ğŸ“‹ å’¨è¯¢æŠ¥å‘Šæ‘˜è¦ï¼š\n\n`;
                summaryText += `â€¢ ä¼šè¯ID: ${summary.session_id}\n`;
                summaryText += `â€¢ æœåŠ¡çº§åˆ«: ${summary.service_level}\n`;
                summaryText += `â€¢ å®Œæˆæ—¶é—´: ${summary.completion_time}\n`;
                summaryText += `â€¢ æ¡ˆä¾‹åˆ†æ: ${summary.has_case_analysis ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}\n`;

                this.addMessage('system', summaryText);
            }

            updateUI(result) {
                this.elements.statusText.textContent = 'ä¼šè¯è¿›è¡Œä¸­';
                this.elements.sessionInfo.textContent = `ä¼šè¯ID: ${result.session_id}`;
                this.elements.phaseIndicator.style.display = 'block';
                this.updatePhase(result.phase_name);
                this.elements.startBtn.style.display = 'none';
            }

            updatePhase(phaseName) {
                this.elements.currentPhase.textContent = phaseName;
            }

            enableInput() {
                this.elements.messageInput.disabled = false;
                this.elements.sendBtn.disabled = false;
                this.elements.messageInput.focus();
            }

            disableInput() {
                this.elements.messageInput.disabled = true;
                this.elements.sendBtn.disabled = true;
            }

            showLoading(show) {
                this.elements.loading.classList.toggle('show', show);
                if (show) {
                    this.scrollToBottom();
                }
            }

            showServiceSelection() {
                this.elements.inputArea.style.display = 'none';
                this.elements.serviceSelection.style.display = 'block';
            }

            hideServiceSelection() {
                this.elements.serviceSelection.style.display = 'none';
                this.elements.inputArea.style.display = 'block';
            }

            showInput() {
                this.elements.inputArea.style.display = 'block';
                this.elements.messageInput.disabled = false;
                this.elements.sendBtn.disabled = false;
            }

            disableInput() {
                this.elements.messageInput.disabled = true;
                this.elements.sendBtn.disabled = true;
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
                }, 100);
            }

            // ä¸¾è¯åˆ†æç•Œé¢æ§åˆ¶æ–¹æ³•
            showEvidenceProgress() {
                this.elements.evidenceProgress.style.display = 'block';
            }

            hideEvidenceProgress() {
                this.elements.evidenceProgress.style.display = 'none';
            }

            showEvidenceInventory() {
                this.elements.inputArea.style.display = 'none';
                this.elements.evidenceInventory.style.display = 'block';
            }

            hideEvidenceInventory() {
                this.elements.evidenceInventory.style.display = 'none';
                this.elements.inputArea.style.display = 'block';
            }

            showEvidenceAnalysis() {
                this.elements.inputArea.style.display = 'none';
                this.elements.evidenceAnalysis.style.display = 'block';
            }

            hideEvidenceAnalysis() {
                this.elements.evidenceAnalysis.style.display = 'none';
                this.elements.inputArea.style.display = 'block';
            }

            updateEvidenceStep(step, completed = false) {
                const steps = document.querySelectorAll('.step');
                steps.forEach((stepEl, index) => {
                    const stepNum = index + 1;
                    stepEl.classList.remove('active', 'completed');
                    
                    if (stepNum < step || (stepNum === step && completed)) {
                        stepEl.classList.add('completed');
                    } else if (stepNum === step) {
                        stepEl.classList.add('active');
                    }
                });
            }

            addCaseInfo(title, caseInfo) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                
                // æ•°æ®éªŒè¯å’Œé»˜è®¤å€¼å¤„ç†
                const safeInfo = {
                    employee_name: caseInfo.employee_name || 'å½“äº‹äºº',
                    company_name: caseInfo.company_name || 'æœªæä¾›å…¬å¸åç§°ï¼ˆå»ºè®®è¡¥å……å®Œæ•´å…¬å¸åç§°ï¼‰',
                    dispute_type: caseInfo.dispute_type || 'åŠ³åŠ¨äº‰è®®',
                    monthly_salary: caseInfo.monthly_salary || 'æœªçŸ¥',
                    hire_date: caseInfo.hire_date || 'æœªçŸ¥',
                    termination_date: caseInfo.termination_date || 'æœªçŸ¥'
                };
                
                // æ ¼å¼åŒ–æœˆè–ªæ˜¾ç¤º
                const salaryDisplay = safeInfo.monthly_salary === 'æœªçŸ¥' ? 'æœªçŸ¥' : `${safeInfo.monthly_salary}å…ƒ`;
                
                let infoHtml = `<div class="message-content">
                    <strong>${title}ï¼š</strong>
                    <div style="background: #f8f9fa; color: #333; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <div style="margin-bottom: 8px; color: #333;"><strong>å½“äº‹äººï¼š</strong>${safeInfo.employee_name}</div>
                        <div style="margin-bottom: 8px; color: #333;"><strong>å…¬å¸åç§°ï¼š</strong>${safeInfo.company_name}</div>
                        <div style="margin-bottom: 8px; color: #333;"><strong>äº‰è®®ç±»å‹ï¼š</strong>${safeInfo.dispute_type}</div>
                        <div style="margin-bottom: 8px; color: #333;"><strong>æœˆè–ªï¼š</strong>${salaryDisplay}</div>
                        <div style="margin-bottom: 8px; color: #333;"><strong>å…¥èŒæ—¥æœŸï¼š</strong>${safeInfo.hire_date}</div>
                        <div style="color: #333;"><strong>è§£é™¤æ—¥æœŸï¼š</strong>${safeInfo.termination_date}</div>
                    </div>
                </div>`;
                
                messageDiv.innerHTML = infoHtml;
                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            displayParsedEvidence(evidenceList) {
                let html = '';
                evidenceList.forEach((evidence, index) => {
                    html += `
                        <div class="evidence-item">
                            <div class="evidence-info">
                                <div class="evidence-name">${evidence.name}</div>
                                <div class="evidence-type">${evidence.type_name || evidence.type}</div>
                            </div>
                        </div>
                    `;
                });
                this.elements.evidenceListDisplay.innerHTML = html;
            }

            displayEvidenceOverview(evidenceOverview) {
                let html = '<h4>è¯æ®æ¦‚è§ˆï¼š</h4>';
                evidenceOverview.forEach((evidence, index) => {
                    html += `
                        <div class="evidence-item">
                            <div class="evidence-info">
                                <div class="evidence-name">${index + 1}. ${evidence.name}</div>
                                <div class="evidence-type">${evidence.type_name} - ${evidence.description}</div>
                            </div>
                        </div>
                    `;
                });
                this.elements.evidenceOverview.innerHTML = html;
            }

            async loadUploadedFiles() {
                try {
                    const response = await fetch(`/api/upload/list?session_id=${this.sessionId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateFileList(result.files);
                        this.updateFileSelector(result.files);
                    }
                } catch (error) {
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                }
            }

            updateFileList(files) {
                let html = '';
                files.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <span class="file-icon">ğŸ“„</span>
                                <span class="file-name">${file.filename}</span>
                                <span class="file-size">(${this.formatFileSize(file.file_size)})</span>
                            </div>
                        </div>
                    `;
                });
                this.elements.uploadedFiles.innerHTML = html;
            }

            updateFileSelector(files) {
                let html = '<option value="">é€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶</option>';
                files.forEach(file => {
                    html += `<option value="${file.filename}">${file.filename}</option>`;
                });
                this.elements.fileSelector.innerHTML = html;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            handleDragOver(e) {
                e.preventDefault();
                this.elements.uploadDropzone.classList.add('dragover');
            }

            handleFileDrop(e) {
                e.preventDefault();
                this.elements.uploadDropzone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                this.uploadFiles(files);
            }

            handleFileSelect(e) {
                const files = e.target.files;
                this.uploadFiles(files);
            }

            async uploadFiles(files) {
                for (let file of files) {
                    await this.uploadFile(file);
                }
                this.loadUploadedFiles();
            }

            async uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', this.sessionId);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.addMessage('system', `âœ… æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`);
                    } else {
                        this.addMessage('error', `âŒ æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: ${result.error}`);
                    }
                } catch (error) {
                    this.addMessage('error', `âŒ æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }
            }

            updateAnalysisProgress(progressData) {
                // ç¡®ä¿è¿›åº¦ç™¾åˆ†æ¯”ä¸è¶…è¿‡100%
                const percentage = Math.min(progressData.progress_percentage || 0, 100);
                this.elements.progressFill.style.width = percentage + '%';
                this.elements.progressText.textContent = `${percentage}% å®Œæˆ (${progressData.analyzed_count}/${progressData.total_evidence})`;
                
                // æ˜¾ç¤ºå·²åˆ†ææ–‡ä»¶ï¼Œå»é‡å¤„ç†
                let html = '';
                if (progressData.analyzed_evidence) {
                    // ä½¿ç”¨Mapå»é‡ï¼Œä»¥æ–‡ä»¶åä¸ºkey
                    const uniqueEvidence = new Map();
                    progressData.analyzed_evidence.forEach(evidence => {
                        uniqueEvidence.set(evidence.file_name, evidence);
                    });
                    
                    // æ˜¾ç¤ºå»é‡åçš„åˆ†æç»“æœ
                    uniqueEvidence.forEach(evidence => {
                        const statusClass = evidence.validity === 'æ˜¯' ? 'valid' : 
                                          evidence.validity === 'å¦' ? 'invalid' : 'unknown';
                        html += `
                            <div class="analyzed-file-item">
                                <div>
                                    <strong>${evidence.file_name}</strong>
                                    <div style="font-size: 12px; color: #6c757d;">${evidence.file_type}</div>
                                </div>
                                <span class="file-status ${statusClass}">${evidence.validity}</span>
                            </div>
                        `;
                    });
                }
                this.elements.analyzedFilesList.innerHTML = html;
                this.elements.analysisProgress.style.display = 'block';
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                console.log(`åˆ†æè¿›åº¦æ›´æ–°: ${percentage}%, å·²åˆ†æ: ${progressData.analyzed_count}, æ€»æ•°: ${progressData.total_evidence}, can_proceed: ${progressData.can_proceed}`);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        let aiLawyerChat;
        document.addEventListener('DOMContentLoaded', () => {
            aiLawyerChat = new AILawyerChat();
        });
    </script>
</body>
</html>